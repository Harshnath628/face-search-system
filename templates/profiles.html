{% extends "base.html" %}

{% block title %}All Profiles - Face Search System{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-users"></i> All Profiles</h2>
    <div>
        <a href="{{ url_for('add_profile_form') }}" class="btn btn-success">
            <i class="fas fa-user-plus"></i> Add New Profile
        </a>
        <a href="{{ url_for('upload_file') }}" class="btn btn-primary">
            <i class="fas fa-search"></i> Search by Image
        </a>
    </div>
</div>

<!-- Statistics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <h3>{{ stats.total_profiles }}</h3>
                <p class="mb-0">Total Profiles</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h3>{{ stats.total_encodings }}</h3>
                <p class="mb-0">Face Encodings</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <h3>{{ "%.1f"|format(stats.current_tolerance) }}</h3>
                <p class="mb-0">Search Tolerance</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body text-center">
                <h3>{{ "%.1f"|format(stats.database_size / (1024*1024)) }}MB</h3>
                <p class="mb-0">Database Size</p>
            </div>
        </div>
    </div>
</div>

{% if profiles %}
<!-- Search and Filter -->
<div class="row mb-3">
    <div class="col-md-6">
        <div class="input-group">
            <input type="text" class="form-control" placeholder="Search profiles..." id="searchProfiles">
            <span class="input-group-text"><i class="fas fa-search"></i></span>
        </div>
    </div>
    <div class="col-md-3">
        <select class="form-select" id="sortProfiles" onchange="sortProfiles()">
            <option value="name">Sort by Name</option>
            <option value="date">Sort by Date Added</option>
            <option value="age">Sort by Age</option>
        </select>
    </div>
    <div class="col-md-3">
        <select class="form-select" id="viewMode" onchange="changeViewMode()">
            <option value="grid">Grid View</option>
            <option value="list">List View</option>
        </select>
    </div>
</div>

<!-- Profiles Grid -->
<div class="row" id="profilesContainer">
    {% for profile_id, profile in profiles.items() %}
    <div class="col-lg-4 col-md-6 mb-4 profile-item" 
         data-name="{{ profile.name|lower }}" 
         data-description="{{ profile.description|lower }}"
         data-date="{{ profile.created_date }}"
         data-age="{{ profile.age }}">
        <div class="card h-100">
            <div class="card-img-top-container" style="height: 200px; overflow: hidden;">
                <img src="{{ url_for('uploaded_file', filename=profile.image_path.split('/')[-1]) }}" 
                     class="card-img-top h-100 w-100" 
                     style="object-fit: cover;"
                     alt="{{ profile.name }}">
            </div>
            <div class="card-body d-flex flex-column">
                <h5 class="card-title">
                    {{ profile.name }}
                    {% if profile.age %}
                    <small class="text-muted">({{ profile.age }})</small>
                    {% endif %}
                </h5>
                
                {% if profile.description %}
                <p class="card-text text-muted flex-grow-1">
                    {{ profile.description[:100] }}
                    {% if profile.description|length > 100 %}...{% endif %}
                </p>
                {% else %}
                <p class="card-text text-muted flex-grow-1">No description provided.</p>
                {% endif %}
                
                <div class="mt-auto">
                    <small class="text-muted d-block mb-2">
                        Added: {{ profile.created_date[:10] if profile.created_date else 'Unknown' }}
                    </small>
                    <div class="d-flex gap-2">
                        <a href="{{ url_for('view_profile', profile_id=profile_id) }}" 
                           class="btn btn-primary btn-sm flex-fill">
                            <i class="fas fa-eye"></i> View
                        </a>
                        <a href="{{ url_for('delete_profile', profile_id=profile_id) }}" 
                           class="btn btn-danger btn-sm"
                           onclick="return confirm('Are you sure you want to delete this profile?')">
                            <i class="fas fa-trash"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- No Results Message -->
<div id="noResults" style="display: none;" class="text-center py-5">
    <i class="fas fa-search fa-3x text-muted mb-3"></i>
    <h4>No profiles found</h4>
    <p class="text-muted">Try adjusting your search criteria.</p>
</div>

{% else %}
<!-- Empty State -->
<div class="text-center py-5">
    <i class="fas fa-users fa-5x text-muted mb-4"></i>
    <h3>No Profiles Yet</h3>
    <p class="text-muted mb-4">
        Get started by adding your first profile to the face recognition database.
    </p>
    <a href="{{ url_for('add_profile_form') }}" class="btn btn-success btn-lg">
        <i class="fas fa-user-plus"></i> Add First Profile
    </a>
</div>
{% endif %}

<!-- Pagination (if needed in future) -->
<nav aria-label="Profiles pagination" class="mt-4">
    <ul class="pagination justify-content-center">
        <!-- Pagination will be added here if needed -->
    </ul>
</nav>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchProfiles');
    const profileItems = document.querySelectorAll('.profile-item');
    const noResults = document.getElementById('noResults');
    
    // Search functionality
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            let visibleCount = 0;
            
            profileItems.forEach(item => {
                const name = item.dataset.name;
                const description = item.dataset.description;
                
                if (name.includes(searchTerm) || description.includes(searchTerm)) {
                    item.style.display = 'block';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });
            
            // Show/hide no results message
            if (visibleCount === 0 && searchTerm !== '') {
                noResults.style.display = 'block';
            } else {
                noResults.style.display = 'none';
            }
        });
    }
});

function sortProfiles() {
    const sortBy = document.getElementById('sortProfiles').value;
    const container = document.getElementById('profilesContainer');
    const items = Array.from(container.children);
    
    items.sort((a, b) => {
        switch(sortBy) {
            case 'name':
                return a.dataset.name.localeCompare(b.dataset.name);
            case 'date':
                return new Date(b.dataset.date) - new Date(a.dataset.date);
            case 'age':
                const ageA = parseInt(a.dataset.age) || 0;
                const ageB = parseInt(b.dataset.age) || 0;
                return ageA - ageB;
            default:
                return 0;
        }
    });
    
    items.forEach(item => container.appendChild(item));
}

function changeViewMode() {
    const viewMode = document.getElementById('viewMode').value;
    const profileItems = document.querySelectorAll('.profile-item');
    
    if (viewMode === 'list') {
        profileItems.forEach(item => {
            item.className = 'col-12 mb-3 profile-item';
            // Modify card layout for list view
            const card = item.querySelector('.card');
            card.classList.add('flex-row');
            const imgContainer = item.querySelector('.card-img-top-container');
            imgContainer.style.width = '200px';
            imgContainer.style.height = '150px';
        });
    } else {
        profileItems.forEach(item => {
            item.className = 'col-lg-4 col-md-6 mb-4 profile-item';
            // Reset card layout for grid view
            const card = item.querySelector('.card');
            card.classList.remove('flex-row');
            const imgContainer = item.querySelector('.card-img-top-container');
            imgContainer.style.width = 'auto';
            imgContainer.style.height = '200px';
        });
    }
}

// Add smooth animations
document.querySelectorAll('.profile-item').forEach(item => {
    item.addEventListener('mouseenter', function() {
        this.style.transform = 'translateY(-5px)';
        this.style.transition = 'transform 0.3s ease';
    });
    
    item.addEventListener('mouseleave', function() {
        this.style.transform = 'translateY(0)';
    });
});
</script>
{% endblock %}
