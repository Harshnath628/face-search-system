{% extends "base.html" %}

{% block title %}Add Profile - Face Search System{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header text-center">
                <h2><i class="fas fa-user-plus"></i> Add New Profile</h2>
                <p class="text-muted mb-0">Add a person's face to the database for future searches</p>
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data" id="profileForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="name" class="form-label">
                                    <i class="fas fa-user"></i> Full Name *
                                </label>
                                <input type="text" class="form-control" id="name" name="name" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="age" class="form-label">
                                    <i class="fas fa-calendar"></i> Age
                                </label>
                                <input type="number" class="form-control" id="age" name="age" min="0" max="150">
                            </div>
                            
                            <div class="mb-3">
                                <label for="description" class="form-label">
                                    <i class="fas fa-info-circle"></i> Description
                                </label>
                                <textarea class="form-control" id="description" name="description" rows="4" 
                                          placeholder="Any additional information about this person..."></textarea>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="file" class="form-label">
                                    <i class="fas fa-camera"></i> Profile Photo *
                                </label>
                                <div class="upload-area" id="uploadArea">
                                    <div class="text-center">
                                        <i class="fas fa-user-circle fa-3x text-muted mb-3"></i>
                                        <h5>Upload Face Photo</h5>
                                        <p class="text-muted">Drag & drop or click to select</p>
                                        <input type="file" class="form-control" name="file" id="file" 
                                               accept="image/*" required style="display: none;">
                                        <button type="button" class="btn btn-outline-primary" 
                                                onclick="document.getElementById('file').click();">
                                            <i class="fas fa-folder-open"></i> Choose Photo
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Image Preview -->
                                <div id="imagePreview" class="mt-3 text-center" style="display: none;">
                                    <img id="previewImg" class="img-fluid rounded border" style="max-height: 200px;">
                                    <p class="mt-2 small text-muted">
                                        <span id="fileName"></span> (<span id="fileSize"></span>)
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h5><i class="fas fa-check-circle text-success"></i> Photo Requirements</h5>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-check text-success"></i> Clear, well-lit face photo</li>
                                <li><i class="fas fa-check text-success"></i> Front-facing or near-front angle</li>
                                <li><i class="fas fa-check text-success"></i> Eyes, nose, and mouth visible</li>
                                <li><i class="fas fa-check text-success"></i> No sunglasses or face coverings</li>
                                <li><i class="fas fa-check text-success"></i> Single person in the image</li>
                            </ul>
                        </div>
                        
                        <div class="col-md-6">
                            <h5><i class="fas fa-exclamation-triangle text-warning"></i> Important Notes</h5>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-info text-info"></i> Only one face should be in the image</li>
                                <li><i class="fas fa-info text-info"></i> Higher quality images work better</li>
                                <li><i class="fas fa-info text-info"></i> Avoid blurry or low-resolution photos</li>
                                <li><i class="fas fa-info text-info"></i> Maximum file size: 16MB</li>
                                <li><i class="fas fa-info text-info"></i> Supported formats: JPG, PNG, GIF, BMP</li>
                            </ul>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="text-center">
                        <button type="submit" class="btn btn-success btn-lg" id="submitBtn">
                            <i class="fas fa-plus-circle"></i> Add Profile to Database
                        </button>
                        <a href="{{ url_for('view_profiles') }}" class="btn btn-secondary btn-lg ms-2">
                            <i class="fas fa-times"></i> Cancel
                        </a>
                    </div>
                </form>
                
                <!-- Progress indicator -->
                <div id="progressIndicator" class="mt-3" style="display: none;">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Processing face and adding to database...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Help Section -->
<div class="row mt-5">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h4><i class="fas fa-question-circle"></i> Need Help?</h4>
            </div>
            <div class="card-body">
                <div class="accordion" id="helpAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#help1">
                                What makes a good profile photo?
                            </button>
                        </h2>
                        <div id="help1" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
                            <div class="accordion-body">
                                A good profile photo should be clear, well-lit, and show the person's face clearly. 
                                The person should be looking directly at the camera or at a slight angle. 
                                Avoid photos with shadows, sunglasses, hats, or other obstructions.
                            </div>
                        </div>
                    </div>
                    
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#help2">
                                Can I add multiple photos of the same person?
                            </button>
                        </h2>
                        <div id="help2" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
                            <div class="accordion-body">
                                Currently, each profile contains one main photo. If you want to add another photo of the same person, 
                                you would need to create a separate profile entry. However, the system will recognize similar faces 
                                during searches.
                            </div>
                        </div>
                    </div>
                    
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#help3">
                                How secure is the data?
                            </button>
                        </h2>
                        <div id="help3" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
                            <div class="accordion-body">
                                All profile data is stored locally on your system. Photos are stored securely and face encodings 
                                are generated using advanced algorithms. Only authorized users with access to the system can view 
                                the profiles.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('file');
    const uploadArea = document.getElementById('uploadArea');
    const imagePreview = document.getElementById('imagePreview');
    const previewImg = document.getElementById('previewImg');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const submitBtn = document.getElementById('submitBtn');
    const profileForm = document.getElementById('profileForm');
    const progressIndicator = document.getElementById('progressIndicator');
    
    // File input change
    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            showImagePreview(file);
        }
    });
    
    // Drag and drop
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            const file = files[0];
            if (isValidImageFile(file)) {
                fileInput.files = files;
                showImagePreview(file);
            } else {
                alert('Please select a valid image file.');
            }
        }
    });
    
    // Form submission
    profileForm.addEventListener('submit', function(e) {
        const name = document.getElementById('name').value.trim();
        const file = fileInput.files[0];
        
        if (!name) {
            alert('Please enter a name for the profile.');
            e.preventDefault();
            return;
        }
        
        if (!file) {
            alert('Please select a photo for the profile.');
            e.preventDefault();
            return;
        }
        
        // Show progress indicator
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        progressIndicator.style.display = 'block';
    });
    
    function showImagePreview(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            previewImg.src = e.target.result;
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            imagePreview.style.display = 'block';
        };
        reader.readAsDataURL(file);
    }
    
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    function isValidImageFile(file) {
        const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/bmp'];
        return validTypes.includes(file.type);
    }
    
    // Real-time validation
    document.getElementById('name').addEventListener('input', function() {
        const name = this.value.trim();
        if (name.length < 2) {
            this.classList.add('is-invalid');
        } else {
            this.classList.remove('is-invalid');
            this.classList.add('is-valid');
        }
    });
});
</script>
{% endblock %}
